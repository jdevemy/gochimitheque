extends static/templates/base.jade

block content
    #accordion
        #list-collapse.collapse.show(data-parent='#accordion')
            header.row
                .col-sm-12
                    table#table(data-toggle='table', 
                                data-striped='true', 
                                data-search='true', 
                                data-side-pagination='server', 
                                data-page-list="[10, 20, 50, 100]",
                                data-pagination='true', 
                                data-ajax='getData', 
                                data-sort-name='entity_name')
                        thead
                            tr
                                th(data-field='entity_id') ID
                                th(data-field='entity_name' data-sortable='true') name
                                th(data-field='entity_description' data-sortable='true') description
                                th(data-field='managers' data-sortable='true' data-formatter='managersFormatter') manager(s)
                                th(data-field='operate', data-formatter='operateFormatter', data-events='operateEvents') actions

        #edit-collapse.collapse(data-parent='#accordion')
            form#entity-update
                input#index(type='hidden', name='index', value='')
                input#entity_id(type='hidden', name='entity_id', value='')

                .form-group.row
                    | {{$label := "name"}} {{$name := "entity_name"}}
                    +inputtext
                .form-group.row
                    | {{$label := "description"}} {{$name := "entity_description"}}
                    +inputtext
                .form-group.row
                    | {{$label := "manager(s)"}} {{$name := "managers"}}
                    +selectmultiple

            button#save.btn.btn-primary(type='button', onclick='saveEntity()') save changes
            button.btn.btn-secondary(type='button', onclick='closeViewEdit();') close

block contentjs
    script.
        //
        // close buttons actions
        //
        function closeViewEdit() { $("#list-collapse").collapse("show"); $("#edit-collapse").collapse("hide"); }
        
        $( document ).ready(function() {
            
            // initializing query parameters map
            var URLValues = new Map();
            {{ range $key, $value := .URLValues }}
                URLValues.set({{ $key }}, {{ $value }});
            {{ end }}

            // populating search input if needed
            if (URLValues.has("search")) {
                $('#table').bootstrapTable('resetSearch', URLValues.get("search")[0]);
            }

            //
            // update form validation
            //
            $( "#entity-update" ).validate({
            errorClass: "alert alert-danger",
            rules: {
                entity_name: {
                    required: true,
                    remote: {
                        url: "/validate/entity/-1/name/",
                        type: "post",
                        beforeSend: function(jqXhr, settings) {
                            settings.url = "/validate/entity/" + $("form#entity-update input#entity_id").val() + "/name/";
                        },
                    },
                },
            },
            });

            //
            // manager select2
            //
            $('select#managers').select2({
                dropdownParent: $('#edit-collapse'),
                ajax: {
                    url: '/people',
                    dataType: 'json',
                    processResults: function (data) {
                        // replacing email by text expected by select2
                        var newdata = $.map(data.rows, function (obj) {
                            obj.text = obj.text || obj.person_email;
                            obj.id = obj.id || obj.person_id;
                            return obj;
                        });
                        return {
                            results: newdata
                        };
                    }
                }
            });
        });
        
        //
        // save entity callback
        //
        function saveEntity() {
            var form = $("#entity-update");
            if (! form.valid()) {
                return;
            };

            var entity_id = $("#edit-collapse input#entity_id").val(),
                entity_name = $("#edit-collapse input#entity_name").val(),
                entity_description = $("#edit-collapse input#entity_description").val(),
                managers = $('select#managers').select2('data');
                data = {};
                $.each(managers, function( index, m ) {
                    data["managers." + index +".person_id"] = m.id;
                    data["managers." + index +".person_email"] = m.text;
                });
                $.extend(data, {
                    "entity_id": entity_id,
                    "entity_name": entity_name,
                    "entity_description": entity_description,
                });
                $.ajax({
                    url: "/entities/" + id,
                    method: "PUT",
                    dataType: 'json',
                    data: data,
                }).done(function(data, textStatus, jqXHR) {
                    $('#list-collapse').collapse('show');
                    $('#edit-collapse').collapse('hide');
                    var $table = $('#table');
                    var index = $('input#index').val();
                    $table.bootstrapTable('updateRow', {
                        index: index,
                        row: {
                            "entity_name": entity_name,
                            "entity_description": entity_description,
                        }
                    });
                    displayMessage("entity " + entity_name + " updated", "success");
                }).fail(function(jqXHR, textStatus, errorThrown) {
                    handleHTTPError(jqXHR.statusText, jqXHR.status)
                });  
        }

        //
        // table data loading
        //
        function getData(params) {
            $.ajax({
                url: "/entities",
                method: "GET",
                dataType: "JSON",
                data: params.data,
            }).done(function(data, textStatus, jqXHR) {
                params.success({
                    rows: data.rows,
                    total: data.total,
                });
            }).fail(function(jqXHR, textStatus, errorThrown) {
                params.error(jqXHR.statusText);                
                handleHTTPError(jqXHR.statusText, jqXHR.status)
            });
        }

        //
        // managers formatter
        //
        function managersFormatter(value, row, index, field) {
            var html = [ "<ul>" ]; 
            $.each(value, function( index, m ) {
                html.push("<li>" + m.person_email + "</li>");
            });
            html.push("</ul>");
            return html.join("");
        }

        //
        // table items actions
        //
        function operateFormatter(value, row, index) {
            // show action buttons if permitted
            eid = row.entity_id
            hasPermission2("/f/entities/" + eid, "GET", eid).done(function(){
                    $("#storelocations"+this.itemId).fadeIn();
            })
            hasPermission2("/f/entities/" + eid, "GET", eid).done(function(){
                    $("#members"+this.itemId).fadeIn();
            })
            hasPermission2("/f/entities/" + eid, "PUT", eid).done(function(){
                    $("#edit"+this.itemId).fadeIn();
            })
            hasPermission2("/f/entities/" + eid, "DELETE", eid).done(function(){
                    $("#delete"+this.itemId).fadeIn();
            })

            // buttons are hidden by default
            var actions = [
            '<button id="storelocations' + eid + '" class="storelocations btn btn-secondary" style="display: none;" title="store locations" type="button">',
                '<i class="fas fa-warehouse"></i>',
            '</button>',
            '<button id="members' + eid + '" class="members btn btn-secondary" style="display: none;" title="members" type="button">',
                '<i class="fas fa-users"></i>',
            '</button>',
            '<button id="edit' + eid + '" class="edit btn btn-secondary" style="display: none;" title="edit" type="button">',
                '<i class="fas fa-edit"></i>',
            '</button>',
            '<button id="delete' + eid + '" class="delete btn btn-secondary" style="display: none;" title="delete" type="button">',
                '<i class="fas fa-trash-alt"></i>',
            '</button>'];

            return actions.join('&nbsp;')    
        }

        // items actions callback
        function operateEdit(e, value, row, index) {
            // clearing selections
            $('select#managers').val(null).trigger('change');
            $('select#managers').find('option').remove();

            // getting the entity
            $.ajax({
                url: "/entities/" + row['entity_id'],
                method: "GET",
            }).done(function(data, textStatus, jqXHR) {
                // flattening response data
                fdata = flatten(data);
                // autofilling form
                $("#edit-collapse").autofill( fdata, {"findbyname": false } );
                // setting index hidden input
                $("input#index").val(index);
            }).fail(function(jqXHR, textStatus, errorThrown) {
                handleHTTPError(jqXHR.statusText, jqXHR.status)
            });

            // getting the entity managers
            $.ajax({
                url: "/entities/" + row['entity_id'] + "/people",
                method: "GET",
            }).done(function(data, textStatus, jqXHR) {
                // select2 is not autofilled - we need a special operation
                for(var i in data) {
                   var newOption = new Option(data[i].person_email, data[i].person_id, true, true);
                   $('select#managers').append(newOption).trigger('change');
                }
            }).fail(function(jqXHR, textStatus, errorThrown) {
                handleHTTPError(jqXHR.statusText, jqXHR.status)
            });

            // finally collapsing the view
            $('#edit-collapse').collapse('show');
            $('#list-collapse').collapse('hide');
        }
        window.operateEvents = {
            'click .storelocations': function (e, value, row, index) {
                window.location.href = "/v/storelocations?entityid=" + row['entity_id'];
            },
            'click .members': function (e, value, row, index) {
                window.location.href = "/v/people?entityid=" + row['entity_id'];
            },
            'click .edit': function (e, value, row, index) {
                operateEdit(e, value, row, index)
            },
            'click .delete': function (e, value, row, index) {
                // hiding possible previous confirmation button
                $(this).confirmation("show").off( "confirmed.bs.confirmation");
                $(this).confirmation("show").off( "canceled.bs.confirmation");
                
                // ask for confirmation and then delete
                $(this).confirmation("show").on( "confirmed.bs.confirmation", function() {
                    $.ajax({
                        url: "/entities/" + row['entity_id'],
                        method: "DELETE",
                    }).done(function(data, textStatus, jqXHR) {
                        displayMessage("entity deleted", "success");
                        var $table = $('#table');
                        $table.bootstrapTable('refresh');
                    }).fail(function(jqXHR, textStatus, errorThrown) {
                        handleHTTPError(jqXHR.statusText, jqXHR.status)
                    });
                }).on( "canceled.bs.confirmation", function() {
                });
            }
        };
